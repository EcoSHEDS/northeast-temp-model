---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Predictions

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
source("../functions.R")
config <- load_config("../../")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = NA)

df <- readRDS(file.path(config$wd, "model-predict-derived.rds"))
```

Once calibrated, the model is used to generate stream temperature predictions for all catchments in the region having drainage areas less than 200 sq km and less than 70% open water coverage. 

First, daily time series of predicted mean temperature are generated for each catchment. The daily predictions are then aggregated by year by calculated various metrics such as mean monthly temperatures and frequencies of exceeding various thresholds. Lastly, the annual temperature metrics are aggregated by catchment over all years in the historical period of record.

For each catchment, predictions are generated by the following steps:

1. Calculate the predicted daily mean stream temperature for each year in the historical period of record (1980 - 2017) during the months of June, July and August
2. For each month and year, calculate the following metrics:
    - Mean monthly temperature (June, July, August)
    - Mean and maximum summer temperature (June 1 - August 31)
    - Maximum 30-day rolling mean temperature
    - Number of days with temperature exceeding 18, 20, and 22 deg C
    - Resistivity computed as the sum of the absolute difference between the predicted stream temperature and the daily mean air temperature (June 1 to August 31)
3. For each catchment, the annual metrics from the previous step are aggregated by calculating the following metrics over all years:
    - Mean monthly (June, July, August) and summer (June 1 - August 31) temperature
    - Mean and maximum of the annual maximum summer temperature
    - Mean of the annual maximum 30-dy rolling mean temperature
    - Mean number of days per year exceeding 18, 20, and 22 deg C
    - Mean resistivity
  
Figure \@ref(fig:plot-pred-hist) shows the distribution (histogram) of each final metric for all catchments.

```{r plot-pred-hist, fig.width=8, fig.height=6, fig.cap="Distributions of Catchment Derived Metrics"}
var_labels <- c(
  "mean_max_temp" = "Mean Annual Max Temp",
  "max_max_temp" = "Maximum Temp",
  "mean_jun_temp" = "Mean June Temp",
  "mean_jul_temp" = "Mean July Temp",
  "mean_aug_temp" = "Mean August Temp",
  "mean_summer_temp" = "Mean Summer Temp",
  "max_temp_30d" = "Max 30-day Mean Temp",
  "n_day_temp_gt_18" = "Mean # Days > 18 C",
  "n_day_temp_gt_20" = "Mean # Days > 20 C",
  "n_day_temp_gt_22" = "Mean # Days > 22 C",
  "resist" = "Resistivity"
)

df %>% 
  gather(var, value, -featureid) %>% 
  mutate(var = factor(var, levels = names(var_labels), ordered = TRUE)) %>% 
  ggplot(aes(value)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ var, scales = "free", labeller = labeller(var = var_labels)) +
  labs(x = "", y = "# Catchments")
```

